# EO tile filter demo

Compact pipeline for PhiSat-2 style onboard EO tile triage: train a tiny CNN on synthetic tiles, export to ONNX, quantize to INT8, calibrate a confidence threshold for a target recall, and simulate event-triggered downlink with logs and a short report. ESA PhiSat-2 overview: https://earth.esa.int/eogateway/missions/phisat-2

## What this includes
- Train `TinyCNN` in PyTorch on synthetic 3‑band tiles
- Export FP32 ONNX, post‑training INT8 (QDQ) with ONNX Runtime
- Threshold calibration to hit a target recall
- Bandwidth filter that keeps only high‑confidence tiles
- JSONL telemetry and a summarizer that writes `reports/summary.md`

## Quick start
From this folder:
```bash
python -m venv .venv && source .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt onnxscript==0.1.0 scikit-learn

# data → train → export → quantize → eval
python -m data.synth --out ./tiles --n 200 --bands 3 --size 64
python -m src.train --data ./tiles --epochs 12 --base 32 --lr 0.003
python -m src.export_onnx --weights runs/tinycnn.pt --out models/tinycnn_fp32.onnx --bands 3 --size 64 --base 32
python -m src.quantize_ptq --onnx models/tinycnn_fp32.onnx --calib ./tiles/val --out models/tinycnn_int8.onnx --size 64 --bands 3
python -m src.infer_onnx --onnx models/tinycnn_int8.onnx --data ./tiles/val --size 64 --bands 3

# calibrate → filter → telemetry → report
python -m src.calibrate_threshold --onnx models/tinycnn_int8.onnx --data ./tiles/val --target_recall 0.95 --out calibration.json
mkdir -p logs
python -m src.bandwidth_filter --onnx models/tinycnn_int8.onnx --data ./tiles/val --calibration calibration.json --downlink_out downlink --log logs/downlink.jsonl
THR=$(python -c "import json; print(json.load(open('calibration.json'))['threshold'])")
python ../../assurance/telemetry_log.py --onnx models/tinycnn_int8.onnx --data ./tiles/val --out logs/val.jsonl --threshold "$THR"
python ../../assurance/summarize.py --val_log logs/val.jsonl --downlink_log logs/downlink.jsonl --val_dir tiles/val --calib calibration.json --out_dir reports
cat reports/summary.md
```

## Latest run (synthetic)
- INT8 accuracy: `1.00`
- Threshold: `0.678`
- Recall at threshold: `0.95`
- Precision at threshold: `1.00`
- AUC: `1.00`
- Avg latency (CPU EP, 1×3×64×64): `0.459 ms`
- Tiles kept: `19 / 40`
- Bandwidth saved: `54.9%`

Numbers come from `logs/*.jsonl` and `reports/summary.md` generated by the commands above.

## Files
- `data/synth.py` tile generator
- `src/train.py` train `TinyCNN`
- `src/export_onnx.py` export FP32 ONNX
- `src/quantize_ptq.py` post‑training INT8
- `src/infer_onnx.py` evaluate accuracy
- `src/bench_onnxruntime.py` latency/memory bench
- `src/bandwidth_filter.py` downlink selector (uses `calibration.json`)
- `logs/` and `reports/` created by the quick start
- See also `../../assurance/` for telemetry and summarizer

## Notes
- Tiles are synthetic for a fast demo; swap in real multispectral crops and recalibrate to keep the same recall target.
- The model is intentionally small to match edge budgets; replace `TinyCNN` and keep the PyTorch→ONNX→INT8 interface stable.

## License
MIT. See [LICENSE](LICENSE).
© Sylvester Kaczmarek · https://www.sylvesterkaczmarek.com